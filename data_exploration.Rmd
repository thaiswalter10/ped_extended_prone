---
title: "Explore Data"
output: html_notebook
---

Ce R Markdown est fait pour identifier le étapes de pré-processing à réaliser pour pouvoir analyser les datas. 
```{r}
library("here")
source(here("code", "R", "packages.R"))
source(here("code", "R", "functions_data.R"))
source(here("code", "R", "functions_analyse.R"))
source(here("code", "R", "functions_visualization.R"))
```


```{r}

```


# Travail sur demog
```{r}
tar_load(demog)
named_demog <- demog %>% left_join(corres_tot, by = "gupi") %>%
  relocate(c("nip", "nom", "prenom", "date_naissance"), .after = gupi)
named_demog %>% filter(plexus_brachial == 1)
write_xlsx(named_demog, here("data", "named_demog.xlsx"))
```

# Travail sur le boxplot
```{r}
df <- tar_read(df_to_plot_vent_var) %>% filter(name_var == "pf")
variable <- "pf"


  ggplot(df, aes(x= time_point, y=value)) +
    geom_boxplot(outlier.shape = NA, fill="grey", alpha=0.3) +
    stat_summary(fun = mean, geom="line", aes(group=1))  + 
    stat_summary(fun=mean, geom="point", shape = 2) +
    theme(panel.background = element_rect(fill = "transparent"),
          axis.line = element_line(size = 0.2, linetype = "solid"),
          axis.text.x = element_text(size=12, angle=0)) +
    scale_x_discrete(name = element_blank()) +
    geom_signif(comparisons = list(c("Baseline", "Supine")),
                annotations="*",
                y_position = 500,
                map_signif_level=TRUE) +
    geom_signif(comparisons = list(c("Prone, H+16", "End of Prone")),
                annotations="**",
                y_position = 400,
                map_signif_level=TRUE) 
  
(pf_plot <- ggdraw(plot_vent_var("pf", df) + 
    geom_signif(comparisons = list(c("Baseline", "Supine")),
                    annotations="*",
                    y_position = 400,
                    map_signif_level=TRUE) +
    geom_signif(comparisons = list(c("Prone, H+16", "End of Prone")),
                    annotations="**",
                    y_position = 370,
                    map_signif_level=TRUE)+ 
    scale_y_continuous(limits = c(0, 430), 
                       name = "Pao2 / Fio2 ratio", 
                       breaks = seq(from=0, to=420, by=50))
  )
)
  
pf_plot 

```


# Travail sur le tableau: "Variation des paramètres ventilatoires lors des séances de DVs"
```{r}
dv <- tar_read(dv)
list_var <- tar_read(info_table1) %>% filter(table == "vent_row") %>% pull(var_name)
list_time_point <- tar_read(info_table1) %>% filter(table == "vent_col") %>% pull(var_name)
df <- map_dfr(list_var, make_single_var_df, dv, list_time_point) %>%
  pivot_wider(names_from = time_point, values_from = value) %>%
  filter(name_var %in% c("fio2", "vt", "pep", "pplt", "ph", "paco2", "pao2", "pf"))

a <- vect_wilcox(df=df, grouping_variable = name_var, x = "pdt_dv", y = "avt_dd")

d3 <- dv
pval = format(wilcox.test(d3$fio2_pdt_dv,d3$fio2_avt_dd,paired=T)$p.value,digits=2)
pval = c(pval,format(wilcox.test(d3$vt_pdt_dv,d3$vt_avt_dd,paired=T)$p.value,digits=2))
pval = c(pval,format(wilcox.test(d3$pep_pdt_dv,d3$pep_avt_dd,paired=T)$p.value,digits=2))
pval = c(pval,format(wilcox.test(d3$pplt_pdt_dv,d3$pplt_avt_dd,paired=T)$p.value,digits=2))
pval = c(pval,format(wilcox.test(d3$ph_pdt_dv,d3$ph_avt_dd,paired=T)$p.value,digits=2))
pval = c(pval,format(wilcox.test(d3$paco2_pdt_dv,d3$paco2_avt_dd,paired=T)$p.value,digits=2))
pval = c(pval,format(wilcox.test(d3$pao2_pdt_dv,d3$pao2_avt_dd,paired=T)$p.value,digits=2))
pval = c(pval,format(wilcox.test(d3$pao2_pdt_dv/d3$fio2_pdt_dv,d3$pao2_avt_dd/d3$fio2_avt_dd,paired=T)$p.value,digits=2))
pval_mep <- enframe(pval) %>% rename(p.value.jimmy = value) %>% select(p.value.jimmy) %>% 
  mutate(name_var = c("fio2", "vt", "pep", "pplt", "ph", "paco2", "pao2", "pf"))


(b <- pval_mep %>% left_join(a, by="name_var") %>% arrange(name_var))
```


# Travail sur le tableau : "Paramètres ventilatoires lors des séances de DV
```{r}
dv <- tar_read(dv)
demog <- tar_read(demog)
dd <- demog %>% 
  mutate(
    pbw = case_when(
      sexe == 1 ~ 50 + (0.91 * (taille-152.4)),
      sexe == 0 ~ 45.5 + (0.91 * (taille-152.4)))
    )
```



```{r}
tar_make()
list_var <- c("fio2", "vt", "pep", "pplt", "ph", "paco2", "pao2", "pf", "drvp", "cpl")
x_label<-tar_read(x_label)
df <- map_dfr(list_var, make_single_var_df, dv, x_label$given_time_point)
info_table1 <- tar_read(info_table1)
info_row <- info_table1 %>% filter(table == "vent_row")
info_col <- info_table1 %>% filter(table == "vent_col")
key_row_names <- info_row %>% pull(print_out_name) %>% setNames(info_row$var_name)
key_col_names <- info_col %>% pull(var_name) %>% setNames(info_col$print_out_name)


do_df <- function() {
  pH <- df %>% compute_interqt(c("ph"), 1) %>% ungroup
  df %>% 
    compute_interqt(list_var, 0) %>% 
    ungroup %>%
    add_row(pH) %>%
    mutate(med_iqr = str_glue("{median} ({q1}-{q3})")) %>%
    select(-median, -q1, -q3) %>%
    mutate(name_var = recode(name_var, !!!key_row_names)) %>%
    pivot_wider(names_from = time_point, values_from = med_iqr) %>%
    rename(all_of(key_col_names))
}

```


# Quels sont les patients pour lesquels je n'ai pas les données sur les escarres ? 
```{r}
gupi_with_dv_without_esca
if (Sys.getenv("LOGNAME") == "utilisateur"){
  (read_xlsx(here("data", "correspondance_table.xlsx")) %>%
    filter(gupi %in% gupi_with_dv_without_esca$gupi) %>%
    write_xlsx(here("data", "patient_missing_escar.xlsx")))
}
```


```{r}
dv %>% pivot_longer()
```

```{r}
family <- tribble(
  ~family,  ~dob_child1,  ~dob_child2, ~gender_child1, ~gender_child2,
       1L, "1998-11-26", "2000-01-29",             1L,             2L,
       2L, "1996-06-22",           NA,             2L,             NA,
       3L, "2002-07-11", "2004-04-05",             2L,             2L,
       4L, "2004-10-10", "2009-08-27",             1L,             1L,
       5L, "2000-12-05", "2005-02-28",             2L,             1L,
)
```

```{r}
family <- family %>% mutate(across(starts_with("dob"), ~parse_date(.x)))
family
```



```{r}
raw_esca_df <- tar_read(raw_esca_df)
(raw_esca_df %>% distinct(localisation))
(raw_esca_df %>% distinct(autre_loc))

esca_df %>% distinct(autre_loc)
list_gupi_with_potential_dorsal_pi <- esca_df %>% filter(autre_loc %in% c("cuisse", "jambe dt", "épaule G", "epaule gauche"))   %>% pull(gupi)
esca_df %>% filter(gupi %in% list_gupi_with_potential_dorsal_pi) %>% left_join(corres_tot, by = "gupi") %>% relocate(nip, nom, prenom) %>% select(-gupi, -date_naissance) 

# Nombre totale d'escarres rapportés
(dim(esca_df)[1])

# Pourcentage des escarres localisés en dorsal: 
round(dim(esca_df %>% filter(autre_loc == "siège"))[1]/dim(esca_df)[1]*100, 1)
```


# Données manquantes
On commence par vérifier si le type de chaque colonnes est bien le bon. 
```{r}
demog %>% 
  summarise(across(.cols = everything(), .fns = ~ sum(is.na(.x)))) %>% 
  pivot_longer(cols = everything(), names_to = "Variables", values_to = "nb_val_manquantes") %>%
  filter(nb_val_manquantes != 0)
```

# Valeurs manquantes DV
```{r}
dv %>% 
  summarise(across(.cols = everything(), .fns = ~ sum(is.na(.x)))) %>% 
  pivot_longer(cols = everything(), names_to = "Variables", values_to = "nb_val_manquantes") %>%
  filter(nb_val_manquantes != 0)
```
Valeurs manquantes escarres
```{r}
esca_df %>% 
  summarise(across(.cols = everything(), .fns = ~ sum(is.na(.x)))) %>% 
  pivot_longer(cols = everything(), names_to = "Variables", values_to = "nb_val_manquantes") %>%
  filter(nb_val_manquantes != 0)
```

```{r}
make_single_var_df <- function(variable, dat, list_time_points = x_label$given_time_point){
  list_var <- map(list_time_points, ~str_c(variable, all_of(.x), sep  = "_")) %>% unlist
  list_df <- map(list_var, ~select(dat, all_of(.x), gupi, numero_seance_dv))
  i = 1
  for (df in list_df){
    list_df[[i]] = df %>% 
      mutate(time_point = str_sub(list_var[i], -6, -1),
             name_var := (str_split(list_var[i], "_"))[[1]][1]) %>%
      rename(value = list_var[i])
    i = i+1
  }
  reduce(list_df, add_row)
}
```


```{r}
 x_label <- tribble(
    ~given_time_point, ~x_label,
    "avt_dv",    "1) Baseline",
    "pdt_dv",    "2) Prone, H+16",
    "avt_dd",    "3) End of Prone",
    "apr_dd",    "4) Supine"
  )
list_var_to_plot <- c("fio2", "pplt", "pf", "drvp", "cpl")
df_to_plot_vent_var <- map_dfr(list_var_to_plot, make_single_var_df, dv) %>% 
    mutate(time_point = factor(time_point, levels = x_label$given_time_point))
```

```{r}
make_single_var_df("cpl")
```


```{r}
make_single_var_df <- function(variable, dat = dv, list_time_points = x_label$given_time_point){
  list_var <- map(list_time_points, ~str_c(variable, all_of(.x), sep  = "_")) %>% unlist
  list_df <- map(list_var, ~select(dat, all_of(.x), gupi, numero_seance_dv))
  i = 1
  for (df in list_df){
    list_df[[i]] = df %>% 
      mutate(time_point = str_sub(list_var[i], -6, -1),
             name_var := (str_split(list_var[i], "_"))[[1]][1]) %>%
      rename(value = list_var[i])
    i = i+1
  }
  reduce(list_df, add_row)
}

# Pour une liste de variable donnée, 
# applique make_single_var_df pour chaque variable puis ajoute toutes les lignes 
# entre elle. Output = un seul df 
create_df_to_plot_vent_var <- function(df = dv){
  list_var_to_plot <- c("fio2", "pplt", "pf", "drvp", "cpl")
  x_label <- tribble(
    ~given_time_point, ~x_label,
    "avt_dv",    "1) Baseline",
    "pdt_dv",    "2) Prone, H+16",
    "avt_dd",    "3) End of Prone",
    "apr_dd",    "4) Supine"
  )
  df_to_plot_vent_var <- map_dfr(list_var_to_plot, make_single_var_df(dat = df)) %>% 
    mutate(time_point = factor(time_point, levels = x_label$given_time_point))
}

plot_vent_var <- function(variable, df = whole_df){
  ggplot(df %>% filter(name_var == variable), aes(x= time_point, y=value)) +
    geom_boxplot(outlier.colour = "black", outlier.shape = 1, fill = "grey") +
    stat_summary(fun = mean, geom="line", aes(group=1))  + 
    stat_summary(fun=mean, geom="point", shape = 2) +
    theme(panel.background = element_rect(fill = "transparent"),
          axis.line = element_line(size = 0.2, linetype = "solid"),
          axis.text.x = element_text(size=12, angle=0),
          scale_y_discrete(variable, breaks=50))
}
```


```{r}
iris %>%
  group_by(Species) %>%
  summarise(across(starts_with("Sepal"), ~ mean(.x, na.rm = TRUE)))
```


##Etude du df escarres
```{r}
esca_df <- tar_read(esca_df)
gupi_avec_escarre <- esca_df %>% filter(escarre == "oui") %>% select(gupi) %>% pull
gupi_avec_escarre <- esca_df %>% filter(escarre == "oui") %>% select(gupi) %>% pull
```
-> Dans le data frame esca_df, si au moins un escarre est renseigné, alors il n'existe pas de ligne pour lesquelles on note "escarre" == "non"


## Etude ma fonction de wilcox maison
```{r}
library("here")
source(here("code", "R", "packages.R"))
library("here")
source(here("code", "R", "packages.R"))
source(here("code", "R", "functions_analyse.R"))
source(here("code", "R", "functions_data.R"))
source(here("code", "R", "functions_visualization.R"))

dv <- tar_read(dv)
key_names_df <- tar_read(info_table1)
  # Création d'une liste contenant le nom des variables à étudier
  list_var <- key_names_df %>% filter(table == "vent_row" & var_name != "ph") %>% pull(var_name)
  list_time_point <- key_names_df %>% filter(table == "vent_col") %>% pull(var_name)
  
  # On reformate le tibble dv 
  df_or <- map_dfr(c(list_var, "ph"), make_single_var_df, dv, list_time_point) 
  
  # Création des tables de correspondances entre nom dans le df et nom dans le tableau à imprimer
  info_row <- key_names_df %>% filter(table == "vent_row")
  info_col <- key_names_df %>% filter(table == "vent_col")
  key_row_names <- info_row %>% pull(print_out_name) %>% setNames(info_row$var_name)
  key_col_names <- info_col %>% pull(var_name) %>% setNames(info_col$print_out_name)
  
  # On formate pH séparemment car l'arrondi se fait à deux chiffres après la virgule
  pH <- df_or %>% compute_interqt(c("ph"), 2) %>% ungroup
  
  # On formate le reste du tableau
  df <- df_or %>% 
    compute_interqt(list_var, 0) %>% 
    ungroup %>%
    add_row(pH) %>%
    mutate(med_iqr = str_glue("{median} ({q1}-{q3})")) %>%
    select(-median, -q1, -q3) %>%
    pivot_wider(names_from = time_point, values_from = med_iqr) %>%
    relocate(name_var, avt_dv, pdt_dv, avt_dd, apr_dd) %>%
    rename(all_of(key_col_names))

  
  # Test de wilcoxon avt_dv versus apr_dd
  df_time_point_as_col <- df_or %>%
    pivot_wider(names_from = time_point, values_from = value)
  
  wt1 <- vect_wilcox(
      df=df_time_point_as_col, 
      grouping_variable = name_var, 
      x = "avt_dv", 
      y = "apr_dd") %>% 
    rename("p* for evolution between before PP and after SP" = p.value)
  
  # Test de wilcoxon pdt_dv versus avt_dd
  wt2 <- vect_wilcox(
      df=df_time_point_as_col, 
      grouping_variable = name_var, 
      x = "pdt_dv", 
      y = "avt_dd") %>% 
    rename("p* for evolution between 16 hours of PP and before SP"= p.value)
  
  # Association des 3 tableaux 
  df %>% 
    left_join(wt1, by = "name_var") %>%
    left_join(wt2, by = 'name_var') %>%
    mutate(name_var = recode(name_var, !!!key_row_names)) %>%
    rename("Variables" = name_var)
  
library(xlsx)

# 1. Chargement des données
d1 = read.xlsx(here("anonymized_data", "demog_ano.xlsx"),1,encoding="UTF-8")
d3 = read.xlsx(here("anonymized_data", "dv_ano.xlsx"),1,encoding="UTF-8")

# 2. Data Management
d1 = d1[d1$inclus==1,]
d1 = d1[d1$saisie_donnes_dv=="1",]
d3 = d3[d3$gupi %in% d1$gupi,] %>%
  filter(!(gupi == "mb18" & numero_seance_dv == 2))

ll = c("fio2_avt_dv","fio2_pdt_dv","fio2_avt_dd","fio2_apr_dd")
ll = c(ll,"vt_avt_dv","vt_pdt_dv","vt_avt_dd","vt_apr_dd")
ll = c(ll,"pep_avt_dv","pep_pdt_dv","pep_avt_dd","pep_apr_dd")
ll = c(ll,"pplt_avt_dv","pplt_pdt_dv","pplt_avt_dd","pplt_apr_dd")
ll = c(ll,"ph_avt_dv","ph_pdt_dv","ph_avt_dd","ph_apr_dd")
ll = c(ll,"paco2_avt_dv","paco2_pdt_dv","paco2_avt_dd","paco2_apr_dd")
ll = c(ll,"pao2_avt_dv","pao2_pdt_dv","pao2_avt_dd","pao2_apr_dd")
d3[,ll] = lapply(d3[,ll],as.numeric)

fi02 = c(descQ(d3$fio2_avt_dv),descQ(d3$fio2_pdt_dv),descQ(d3$fio2_avt_dd),descQ(d3$fio2_apr_dd))
vt = c(descQ(d3$vt_avt_dv),descQ(d3$vt_pdt_dv),descQ(d3$vt_avt_dd),descQ(d3$vt_apr_dd))
pep = c(descQ(d3$pep_avt_dv),descQ(d3$pep_pdt_dv),descQ(d3$pep_avt_dd),descQ(d3$pep_apr_dd))
pplt = c(descQ(d3$pplt_avt_dv),descQ(d3$pplt_pdt_dv),descQ(d3$pplt_avt_dd),descQ(d3$pplt_apr_dd))
ph = c(descQ(d3$ph_avt_dv,n=2),descQ(d3$ph_pdt_dv,n=2),descQ(d3$ph_avt_dd,n=2),descQ(d3$ph_apr_dd,n=2))
paco2 = c(descQ(d3$paco2_avt_dv),descQ(d3$paco2_pdt_dv),descQ(d3$paco2_avt_dd),descQ(d3$paco2_apr_dd))
pao2 = c(descQ(d3$pao2_avt_dv),descQ(d3$pao2_pdt_dv),descQ(d3$pao2_avt_dd),descQ(d3$pao2_apr_dd))
pafi = c(descQ(d3$pao2_avt_dv/d3$fio2_avt_dv*100),descQ(d3$pao2_pdt_dv/d3$fio2_pdt_dv*100),descQ(d3$pao2_avt_dd/d3$fio2_avt_dd*100),descQ(d3$pao2_apr_dd/d3$fio2_apr_dd*100))

res = rbind(fi02,vt,pep,pplt,ph,paco2,pao2,pafi)

pval = format(wilcox.test(d3$fio2_pdt_dv,d3$fio2_avt_dd,paired=T)$p.value,digits=2)
pval = c(pval,format(wilcox.test(d3$vt_pdt_dv,d3$vt_avt_dd,paired=T)$p.value,digits=2))
pval = c(pval,format(wilcox.test(d3$pep_pdt_dv,d3$pep_avt_dd,paired=T)$p.value,digits=2))
pval = c(pval,format(wilcox.test(d3$pplt_pdt_dv,d3$pplt_avt_dd,paired=T)$p.value,digits=2))
pval = c(pval,format(wilcox.test(d3$ph_pdt_dv,d3$ph_avt_dd,paired=T)$p.value,digits=2))
pval = c(pval,format(wilcox.test(d3$paco2_pdt_dv,d3$paco2_avt_dd,paired=T)$p.value,digits=2))
pval = c(pval,format(wilcox.test(d3$pao2_pdt_dv,d3$pao2_avt_dd,paired=T)$p.value,digits=2))
pval = c(pval,format(wilcox.test(d3$pao2_pdt_dv/d3$fio2_pdt_dv,d3$pao2_avt_dd/d3$fio2_avt_dd,paired=T)$p.value,digits=2))
```

```{r}
(pval.thais = wilcox.test(
  df_time_point_as_col %>% filter(name_var == "vt") %>% select(pdt_dv) %>% pull(),
  df_time_point_as_col %>% filter(name_var == "vt") %>% select(avt_dd) %>% pull(),
  paired=T)$p.value)

(pval.jimmy = wilcox.test(d3$vt_pdt_dv,d3$vt_avt_dd,paired=T)$p.value)
```

